@model StudentSquads.ViewModels.WorkViewModel
@{
	ViewBag.Title = "WorkEditFormAudit";
}

<h2>Редактирование выездного списка</h2>
<button class="btn btn-warning js-change" data-id="@Model.Id">Сохранить</button>
<button class="btn btn-warning js-delete" data-id="@Model.Id">Удалить</button>
@using (Html.BeginForm("", ""))
{
	@*<button type="submit" class="btn btn-default">Снять с должности</button>
		<input type="submit" name="button2" value="Удалить" class="btn btn-default" formaction="@Url.Action("Delete", "Positions")" />*@
	@Html.HiddenFor(m => m.Id, new { @id = "Id" })
	@Html.HiddenFor(m => m.OriginalWorkId, new { @id = "OriginalWorkId" })
	@Html.HiddenFor(m => m.MemberId, new { @id = "MemberId" })
	@Html.HiddenFor(m => m.EmployerId, new { @id = "EmployerId" })
	@Html.HiddenFor(m => m.WorkProjectId, new { @id = "WorkprojectId" })
	<div class="form-group">
		@Html.LabelFor(m => m.Employer)
		@Html.TextBoxFor(m => m.Employer, new { @id = "employer", @class = "form-control", @readonly = "readonly" })
	</div>
	<div class="form-group">
		@Html.LabelFor(m => m.WorkProject)
		@Html.TextBoxFor(m => m.WorkProject, new { @id = "workproject", @class = "form-control", @readonly = "readonly" })
	</div>
	<div class="form-group">
		@Html.LabelFor(m => m.DateofBegin) (@Model.DateofBegin.ToString("dd.MM.yyyy"))
		@Html.TextBoxFor(m => m.DateofBegin, "{0:yyyy.MM.dd}", new { @type = "date", @id = "dateofbegin", @class = "form-control" })
	</div>
	<div class="form-group">
		@Html.LabelFor(m => m.DateofEnd) (@Model.DateofEnd.ToString("dd.MM.yyyy"))
		@Html.TextBoxFor(m => m.DateofEnd, "{0:dd.MM.yyyy}", new { @type = "date", @id = "dateofend", @class = "form-control" })
	</div>
	<div class="form-group">
		@Html.LabelFor(m => m.FIO)
		@Html.TextBoxFor(m => m.FIO, new { @id = "member", @class = "form-control", @readonly = "readonly" })
	</div>
	<div class="checkbox">
		<label>
			@Html.CheckBoxFor(m => m.Alternative, new { @id = "alternative", @readonly = "readonly" }) Альтернативная целина?
		</label>
	</div>
	if (Model.Versions != null)
	{
		<h4>История изменений</h4>
		<table id="enterapplications" class="table table-bordered table-hover">
			<thead>
				<tr>
					<th>ФИО</th>
					<th>Работодатель</th>
					<th>Дата начала</th>
					<th>Дата окончания</th>
					<th>Дата создания</th>
					<th>Вид изменения</th>
					<th>Утверждено</th>
				</tr>
			</thead>
			<tbody>
				@for (int i = 0; i < Model.Versions.Count; i++)
				{
					<tr>
						<td>@Model.Versions[i].FIO</td>
						<td>@Model.Versions[i].Employer</td>
						<td>@Model.Versions[i].DateofBeginString</td>
						<td>@Model.Versions[i].DateofEndString</td>
						<td>@Model.Versions[i].CreateTime</td>
						<td>@Model.Versions[i].ChangeType</td>
						<td>@Model.Versions[i].ApprovedString</td>
					</tr>
				}
			</tbody>
		</table>
	}
}
@section scripts
{
	@Scripts.Render("~/bundles/jqueryval")
	<script>
		$(document).ready(function () {
			//Изменение
			$(".js-change").on("click", function () {
				var button = $(this);
				var vm = {};
				vm.Alternative = document.getElementById('alternative').value;
				vm.DateOfBegin = document.getElementById('dateofbegin').value;
				vm.DateOfEnd = document.getElementById('dateofend').value;
				vm.Id = document.getElementById('Id').value;
				vm.Audit = true;
				vm.MemberId = document.getElementById('MemberId').value;
				vm.OriginalWorkId = document.getElementById('OriginalWorkId').value;
				vm.EmployerId = document.getElementById('EmployerId').value;
				vm.WorkProjectId = document.getElementById('WorkProjectId').value;
				//vm.HeadofStudentSquadsId = button.attr("data-id");
				//vm.PersonId = document.getElementById('personId').value;
				//vm.Position = document.getElementById('position').value;
				//vm.HasRole = document.getElementById('hasrole').value;
				$.ajax({
					url: "/api/works",
					method: "post",
					data: vm
				})
					.done(function () {
						toastr.success("Успешно сохранено");
					})
					.fail(function () {
						toastr.error("Произошла ошибка сохранения");
					});

			});
			//Удаление
			$(".js-delete").on("click", function () {
				var button = $(this);
				var vm = {};
				bootbox.prompt("Вы уверены, что хотите удалить запись в выездном списке?\nУкажите причину:", function (result) {
					if (result) {
						$.ajax({
							url: "/api/works/" + button.attr("data-id") + "/" + result,
							method: "DELETE",
							success: function () {
								bootbox.alert("Запись удалена из списка. Ожидайте утверждения изменений", function () {
									window.location = "/works/allworks"
								});

							}

						});
					}
				});
			});
		});
	</script>
}


