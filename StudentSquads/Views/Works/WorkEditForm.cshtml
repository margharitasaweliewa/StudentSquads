@model StudentSquads.ViewModels.WorkViewModel
@{
	ViewBag.Title = "WorkEditForm";
}
<h2>Редактирование выездного списка</h2>
<button id ="auditsave" audit = "@Model.Audit" class="btn btn-warning js-change" type="submit">Сохранить</button>
<button id ="auditdelete" audit = @Model.Audit class="btn btn-default js-delete" data-id="@Model.Id" type="submit">Удалить</button>
@using (Html.BeginForm("Delete", "Works"))
{

	@*<input type="submit" name="button2" value="Удалить" class="btn btn-default" formaction="@Url.Action("Delete", "Works")" />*@
	@Html.HiddenFor(m => m.Id, new { @id = "Id" })
	@Html.HiddenFor(m => m.OriginalWorkId, new { @id = "OriginalWorkId" })
	@Html.HiddenFor(m => m.MemberId, new { @id = "MemberId" })
	<div class="form-group">
		@Html.LabelFor(m => m.Employer)
		<div class="tt-container">
			@Html.TextBoxFor(m => m.Employer, new { @dataId = Model.EmployerId, @id = "employerid", @class = "form-control" })
		</div>
	</div>
	<div class="form-group">
		@Html.LabelFor(m => m.WorkProject)
		@Html.TextBoxFor(m => m.WorkProject, new { @id = "workproject", @class = "form-control" })
	</div>
	<div class="form-group">
		@Html.LabelFor(m => m.DateofBegin) (@Model.DateofBegin.ToString("dd.MM.yyyy"))
		@Html.TextBoxFor(m => m.DateofBegin, "{0:yyyy.MM.dd}", new { @type = "date", @id = "dateofbegin", @class = "form-control" })
	</div>
	<div class="form-group">
		@Html.LabelFor(m => m.DateofEnd) (@Model.DateofEnd.ToString("dd.MM.yyyy"))
		@Html.TextBoxFor(m => m.DateofEnd, "{0:dd.MM.yyyy}", new { @type = "date", @id = "dateofend", @class = "form-control" })
	</div>
	<div class="form-group">
		@Html.LabelFor(m => m.FIO)
		@Html.TextBoxFor(m => m.FIO, new { @id = "member", @class = "form-control", @readonly = "readonly" })
	</div>
	<div class="checkbox">
		<label>
			@Html.CheckBoxFor(m => m.Alternative, new { @id = "alternative" }) Альтернативная целина?
		</label>
	</div>
	if (Model.Versions != null)
	{
		<h4>История изменений</h4>
		<table id="enterapplications" class="table table-bordered table-hover">
			<thead>
				<tr>
					<th>ФИО</th>
					<th>Работодатель</th>
					<th>Дата начала</th>
					<th>Дата окончания</th>
					<th>Дата создания</th>
					<th>Вид изменения</th>
					<th>Утверждено</th>
				</tr>
			</thead>
			<tbody>
				@for (int i = 0; i < Model.Versions.Count; i++)
				{
					<tr>
						<td>@Model.Versions[i].FIO</td>
						<td>@Model.Versions[i].Employer</td>
						<td>@Model.Versions[i].DateofBeginString</td>
						<td>@Model.Versions[i].DateofEndString</td>
						<td>@Model.Versions[i].CreateTime</td>
						<td>@Model.Versions[i].ChangeType</td>
						<td>@Model.Versions[i].ApprovedString</td>
					</tr>
				}
			</tbody>
		</table>
	}
}

@section scripts
{
	@*@Scripts.Render("~/bundles/jqueryval")*@
	<script>
		$(document).ready(function () {
			var vm = { MembersIds: [] };
			var employers = new Bloodhound({
				datumTokenizer: Bloodhound.tokenizers.obj.whitespace('Name'),
				queryTokenizer: Bloodhound.tokenizers.whitespace,
				remote: {
					url: '/api/Employers?query=%QUERY',
					wildcard: '%QUERY'
				}
			});

			$('#employerid').typeahead({
				minLength: 3,
				highlight: true
			}, {
				name: 'employers',
				display: 'Name',
				source: employers
			}).on("typeahead:select", function (e, employer) {
				employerid.setAttribute('dataid', employer.Id);
				vm.EmployerId = employer.Id;
			});
			////Изменение
			$(".js-change").on("click", function () {
				var button = $(this);
				//vm.HeadofStudentSquadsId = button.attr("data-id");
				//vm.PersonId = document.getElementById('personId').value;
				//vm.Position = document.getElementById('position').value;
				vm.Alternative = document.getElementById('alternative').value;
				vm.DateOfBegin = document.getElementById('dateofbegin').value;
				vm.DateOfEnd = document.getElementById('dateofend').value;
				vm.Id = document.getElementById('Id').value;
				vm.MemberId = document.getElementById('MemberId').value;
				vm.OriginalWorkId = document.getElementById('OriginalWorkId').value;
				if ($('#auditsave').attr("audit") == "True") vm.Audit = true;
				$.ajax({
					url: "/api/works",
					method: "post",
					data: vm
				})
					.done(function () {
						toastr.success("Успешно сохранено");
					})
					.fail(function () {
						toastr.error("Произошла ошибка сохранения");
					});

			});
			$(".js-delete").on("click", function () {
				var button = $(this);
				var vm = {};
				//Если аудита нет
				if ($('#auditsave').attr("audit") == "True") {
					bootbox.prompt("Вы уверены, что хотите удалить запись в выездном списке?\nУкажите причину:", function (result) {
						if (result) {
							$.ajax({
								url: "/api/works/" + button.attr("data-id") + "/" + result,
								method: "DELETE",
								success: function () {
									bootbox.alert("Запись удалена из списка. Ожидайте утверждения изменений", function () {
										window.location = "/works/allworks"
									});

								}

							});
						}
					});
				}
				else {
					bootbox.confirm("Вы уверены, что хотите удалить запись в выездном списке?", function () {
						$.ajax({
							url: "/api/works/" + button.attr("data-id"),
							method: "DELETE",
							success: function () {
								bootbox.alert("Запись удалена из списка", function () {
									window.location = "/works/allworks"
								}
								);
							}

						});

					});

				}

			});

		});
	</script>
}

